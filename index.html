<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org"></script>
    <script>
        var tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("СОХРАНИТЬ В БОТЕ").show();

        // --- УЛЬТРА-ПАРСИНГ ---
        function getScore() {
            var query = window.location.search.substring(1); // Берем всё после "?"
            // Убираем всё, что не цифры (на случай, если там "?score=133" или "?133&v=1")
            var cleanQuery = query.replace(/[^0-9]/g, ''); 
            var parsed = parseInt(cleanQuery);
            
            // Если совсем пусто или NaN — ставим 133 (твой бонус) или 0
            return isNaN(parsed) ? 133 : parsed; 
        }

        var score = getScore();
        var n1 = 0, n2 = 0, n3 = 0;

        function play() {
            if (score <= 0) {
                alert("Очки закончились!");
                return;
            }

            n1 = Math.floor(Math.random() * 10);
            n2 = Math.floor(Math.random() * 10);
            n3 = Math.floor(Math.random() * 10);

            if (n1 == n2 && n1 == n3) {
                score += 500;
            } else {
                score = score - 1;
            }

            syncUrl();
            render();
        }

        function syncUrl() {
            // Магия обновления адресной строки
            var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + score;
            window.history.replaceState({path:newUrl}, '', newUrl);
        }

        function render() {
            document.getElementById('sc').textContent = "Очки: " + score;
            document.getElementById('slots').textContent = n1 + " | " + n2 + " | " + n3;
            tg.MainButton.setText("ЗАПИСАТЬ " + score + " ОЧКОВ");
        }

        tg.onEvent('mainButtonClicked', function() {
            tg.sendData(score.toString());
        });
    </script>
</head>
<body onload="render()" style="text-align:center; background:#2c3e50; color:white; font-family:sans-serif; padding-top:20px;">
    <h2 id="sc">Загрузка...</h2>
    <div id="slots" style="font-size:60px; background:white; color:black; margin:20px; padding:15px; border-radius:10px; font-weight:bold;">
        0 | 0 | 0
    </div>
    <button onclick="play()" style="width:85%; height:70px; font-size:26px; background:#e74c3c; color:white; border:none; border-radius:15px; box-shadow: 0 6px #c0392b;">
        КРУТИТЬ!
    </button>
    <p style="margin-top:20px; font-size:12px; opacity:0.5;">Синхронизация URL активна</p>
</body>
</html>
